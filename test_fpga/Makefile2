LDFLAGS := -Wl,-lm -lm -lprintf_flt  -Wl,-u,vfprintf

ifdef SystemRoot
	SHELL := cmd.exe
	RM := rm -rf
	TOOLCHAIN_PATH :=C:/Program Files (x86)/Atmel/AVR Studio 5.0/AVR ToolChain/bin/
	GCC :=$(TOOLCHAIN_PATH)/avr-gcc.exe
	SIZE :=$(TOOLCHAIN_PATH)/avr-size.exe
	OBJCOPY :=$(TOOLCHAIN_PATH)/avr-objcopy.exe
else
	RM := rm -rf
	GCC := avr-gcc
	SIZE := avr-size
	OBJCOPY := avr-objcopy
endif


COMMA :=,

DEVICE := atmega328
DEFS:= F_CPU=16000000 


PROJ_NAME := test_fpga
C_DEPS := 
LIBS := serial
LIB_DIR :=.

export C_OPTS := -O3 -g2 -Wall -std=gnu99 -mmcu=$(DEVICE)





export DEFSTRING := $(addprefix -D,$(DEFS))
LIB_PATHS := $(foreach lib,$(LIBS),$(LIB_DIR)/$(lib))
LIB_FILES := $(foreach lib,$(LIBS),$(LIB_DIR)/$(lib)/$(lib).c)
INC_PATHS := $(addprefix -I,$(LIB_PATHS))
LINK_LIB_PATHS := $(addprefix -Wl$(COMMA)-L,$(LIB_PATHS))
LINK_LIBS := $(addprefix -Wl$(COMMA)-l,$(LIBS))

SOURCES := $(PROJ_NAME).c
SOURCES += $(addsuffix .c,$(C_DEPS))
SOURCES += $(LIB_FILES)

OBJS := $(SOURCES:%.c=%.o)



.PHONY: all libs $(LIB_PATHS) clean


all: $(PROJ_NAME).elf $(PROJ_NAME).hex size


$(PROJ_NAME).elf: $(OBJS)
	@echo Building target: $@
	"$(GCC)" -mmcu=$(DEVICE)  -o $(PROJ_NAME).elf   $(OBJS)  $(LDFLAGS)
	@echo Finished building target: $@


$(PROJ_NAME).hex: $(PROJ_NAME).elf
	@echo Building target: $@
	"$(OBJCOPY)" -O ihex -R .eeprom -R .fuse -R .lock -R .signature  $<  $@
	@echo Finished building target: $@


size: $(PROJ_NAME).elf
	@"$(SIZE)" -C --mcu=$(DEVICE) $(PROJ_NAME).elf


%.o: %.c libs
	@echo Building file: $<
	"$(GCC)" $(C_OPTS) $(DEFSTRING) $(INC_PATHS) -o $@ -c $<
	@echo Finished building: $<


libs: $(LIB_FILES)

$(LIB_FILES):
	@echo Building libs!
	cd $(@D)
	"$(GCC)" $(C_OPTS) $(DEFSTRING) -o $(@F) -c $<
	@echo Finished building: $<

clean:
	-$(RM) $(OBJS) $(PROJ_NAME).hex $(PROJ_NAME).elf
